version: '3'

services:
  mongodb:
    image: mongo:8.0.3
    container_name: mongodb
    restart: on-failure
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=example
    networks:
      - proxy

  mongolite:
    build: .
    command: R -e "devtools::test()"
    restart: on-failure
    container_name: mongolite
    environment:
      - DB_URI=mongodb
      - DB_HOST=mongodb
      - DB_NAME=
      - DB_USERNAME=root
      - DB_PASSWORD=example
      - DB_OPTIONS=
      - DB_PORT=27017
    networks:
      - proxy

  reverse-proxy:
    image: traefik:v2.3
    security_opt:
      - no-new-privileges:true
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${HOME}/.certs:/etc/certs:ro
      - ${HOME}/.traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ${HOME}/.traefik/config.yml:/etc/traefik/config.yml:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik=true
    networks:
      - proxy

networks:
  proxy:
    external: true